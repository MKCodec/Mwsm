name: ğŸ“¦ Mwsm Publish Sync

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write   # necessÃ¡rio para OIDC / Trusted Publisher

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Instalar jq (para editar package.json)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ§± Corrigir nome do pacote temporariamente
        run: |
          cp package.json package_original.json
          NAME=$(jq -r '.name' package.json)
          LOWER=$(echo "$NAME" | tr '[:upper:]' '[:lower:]')
          if [ "$NAME" != "$LOWER" ]; then
            echo "ğŸ”§ Corrigindo nome do pacote: $NAME â†’ $LOWER"
            jq --arg name "$LOWER" '.name = $name' package.json > tmp.json && mv tmp.json package.json
          else
            echo "âœ… Nome jÃ¡ estÃ¡ em minÃºsculas: $NAME"
          fi
          jq '.name' package.json

      - name: âš™ï¸ Configurar Node.js (Trusted Publisher)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org/'
          always-auth: true

      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi

      - name: ğŸš€ Publicar no npm (via OIDC / Trusted Publisher)
        run: |
          echo "ğŸ›°ï¸ Publicando pacote via OIDC..."
          npm publish --access public
        continue-on-error: false

      - name: â™»ï¸ Restaurar package.json original
        if: always()
        run: |
          if [ -f package_original.json ]; then
            mv -f package_original.json package.json
            echo "â™»ï¸ package.json restaurado ao original"
          fi
